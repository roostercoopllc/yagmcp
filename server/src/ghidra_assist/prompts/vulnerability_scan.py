"""MCP prompt: vulnerability_scan

Generates a security-focused analysis of a decompiled function, looking for
common vulnerability classes such as buffer overflows, format strings, integer
overflows, use-after-free, and more.
"""

from __future__ import annotations

from dataclasses import dataclass
from textwrap import dedent

from ghidra_assist.prompts import register_prompt


@dataclass
class VulnerabilityScanPrompt:
    """Prompt template for vulnerability scanning."""

    name: str = "vulnerability_scan"
    description: str = (
        "Scan a decompiled function for security vulnerabilities — "
        "buffer overflows, format strings, integer issues, and more."
    )

    def render(
        self,
        function_name: str,
        decompilation: str,
        program_name: str = "",
        caller_context: str = "",
    ) -> str:
        """Render the vulnerability scan prompt.

        Args:
            function_name: Name of the function being scanned.
            decompilation: Decompiled pseudo-C source code.
            program_name: Optional program/binary name for context.
            caller_context: Optional information about callers and how
                user-controlled data reaches this function.

        Returns:
            Fully rendered prompt string.
        """
        header = (
            f"Perform a security vulnerability scan on the decompiled function "
            f"`{function_name}`"
        )
        if program_name:
            header += f" from program `{program_name}`"
        header += "."

        caller_block = ""
        if caller_context:
            caller_block = dedent(f"""
                ## Caller / Data-Flow Context
                {caller_context}
            """).strip() + "\n\n"

        return dedent(f"""
            {header}

            ## Decompiled Source
            ```c
            {decompilation}
            ```

            {caller_block}## Instructions
            Analyze the function for security vulnerabilities. For each finding,
            report:

            - **Vulnerability Class** (e.g., CWE-120 Buffer Overflow)
            - **Location** (line or statement within the decompilation)
            - **Severity** (Critical / High / Medium / Low / Informational)
            - **Description** of the issue
            - **Exploitation Scenario** — how an attacker could trigger it
            - **Recommended Fix**

            Check for at least the following classes:

            1. **Buffer Overflow** (stack and heap) — unchecked memcpy, strcpy,
               sprintf, array indexing without bounds checks.
            2. **Format String** — user-controlled format arguments to printf-family
               functions.
            3. **Integer Overflow / Underflow** — arithmetic on sizes or offsets
               that may wrap.
            4. **Use-After-Free / Double-Free** — memory accessed after being freed.
            5. **Null Pointer Dereference** — missing NULL checks before dereference.
            6. **Race Condition** — shared state accessed without synchronization.
            7. **Command / SQL / Path Injection** — unsanitized input passed to
               system(), exec(), or file operations.
            8. **Information Leak** — uninitialized memory, stack data returned to
               the caller.
            9. **Cryptographic Weakness** — hardcoded keys, weak algorithms, improper
               random number generation.
            10. **Authentication / Authorization Bypass** — logic flaws in access
                control checks.

            If no vulnerabilities are found, state that explicitly and note any
            defensive coding practices observed.

            End with a summary table of all findings sorted by severity.
        """).strip() + "\n"


# Register the prompt at import time
PROMPT = register_prompt(VulnerabilityScanPrompt())
