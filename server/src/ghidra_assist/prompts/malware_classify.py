"""MCP prompt: malware_classify

Generates a behavioral classification of a malware sample, mapping
observed capabilities to MITRE ATT&CK techniques and suggesting
a malware family/type.
"""

from __future__ import annotations

from dataclasses import dataclass
from textwrap import dedent

from ghidra_assist.prompts import register_prompt


@dataclass
class MalwareClassifyPrompt:
    """Prompt template for malware behavioral classification."""

    name: str = "malware_classify"
    description: str = (
        "Classify a malware sample's behavior, map to MITRE ATT&CK "
        "techniques, identify C2 protocol, and suggest next analysis steps."
    )

    def render(
        self,
        triage_summary: str,
        import_list: str,
        key_functions: str = "",
        strings_sample: str = "",
    ) -> str:
        """Render the malware classification prompt.

        Args:
            triage_summary: Output from triage_binary (JSON or formatted text).
            import_list: List of imported functions.
            key_functions: Optional decompiled C code for suspicious functions.
            strings_sample: Optional notable strings found in the binary.

        Returns:
            Fully rendered prompt string.
        """
        functions_block = ""
        if key_functions:
            functions_block = dedent(f"""
                ## Key Decompiled Functions
                ```c
                {key_functions}
                ```

            """).strip() + "\n\n"

        strings_block = ""
        if strings_sample:
            strings_block = dedent(f"""
                ## Notable Strings
                ```
                {strings_sample}
                ```

            """).strip() + "\n\n"

        return dedent(f"""
            Perform a behavioral classification of the following malware sample.

            ## Triage Summary
            ```
            {triage_summary}
            ```

            ## Imported Functions
            ```
            {import_list}
            ```

            {functions_block}{strings_block}## Instructions
            Analyze the available evidence and provide:

            1. **Malware Classification**
               - Type: RAT, dropper, downloader, ransomware, worm, infostealer,
                 cryptominer, backdoor, botnet client, rootkit, or other.
               - Confidence level (High / Medium / Low) with reasoning.

            2. **MITRE ATT&CK Mapping**
               For each observed or inferred technique, list:
               - Technique ID (e.g., T1055)
               - Technique name (e.g., Process Injection)
               - Tactic (e.g., Defense Evasion)
               - Evidence from the binary supporting this mapping

               Key techniques to check:
               - T1055 Process Injection
               - T1059 Command and Scripting Interpreter
               - T1071 Application Layer Protocol
               - T1547 Boot or Logon Autostart Execution
               - T1486 Data Encrypted for Impact
               - T1041 Exfiltration Over C2 Channel
               - T1056 Input Capture
               - T1113 Screen Capture
               - T1027 Obfuscated Files or Information
               - T1070 Indicator Removal
               - T1497 Virtualization/Sandbox Evasion

            3. **C2 Protocol Identification**
               - Protocol type: HTTP, HTTPS, DNS, raw TCP, custom binary, IRC, etc.
               - Any identified C2 addresses, domains, or URLs
               - Communication pattern (beacon interval, data encoding)

            4. **Capability Summary**
               Bullet list of what the malware can do:
               - Command execution
               - File operations (upload, download, delete)
               - Keylogging
               - Screen capture
               - Credential theft
               - Lateral movement
               - Persistence mechanisms
               - Data exfiltration

            5. **Recommended Next Steps**
               - Which specific functions should be analyzed deeper
               - What to look for in dynamic analysis
               - Suggested YARA rule indicators
               - Related malware families to compare against

            Be precise and evidence-based. If something cannot be determined
            from the available data, say so explicitly rather than guessing.
        """).strip() + "\n"


# Register the prompt at import time
PROMPT = register_prompt(MalwareClassifyPrompt())
